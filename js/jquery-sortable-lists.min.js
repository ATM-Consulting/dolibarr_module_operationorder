/*
 MIT : https://github.com/camohub/jquery-sortable-lists
 Doc : http://camohub.github.io/jquery-sortable-lists/
*/

// Le sortable
!function(e){e.fn.sortableLists=function(s){var l=e("body").css("position","relative"),t={currElClass:"",placeholderClass:"",placeholderCss:{position:"relative",padding:0},hintClass:"",hintCss:{display:"none",position:"relative",padding:0},hintWrapperClass:"",hintWrapperCss:{},baseClass:"",baseCss:{position:"absolute",top:0-parseInt(l.css("margin-top")),left:0-parseInt(l.css("margin-left")),margin:0,padding:0,"z-index":2500},opener:{active:!1,open:"",close:"",openerCss:{float:"left",display:"inline-block","background-position":"center center","background-repeat":"no-repeat"},openerClass:""},listSelector:"ul",listsClass:"",listsCss:{},insertZone:50,insertZonePlus:!1,scroll:20,ignoreClass:"",handle:"",isAllowed:function(e,s,l){return!0},onDragStart:function(e,s){return!0},onChange:function(e){return!0},complete:function(e){return!0}},o=e.extend(!0,{},t,s),r=e("<"+o.listSelector+" />").prependTo(l).attr("id","sortableListsBase").css(o.baseCss).addClass(o.listsClass+" "+o.baseClass),i=e("<li />").attr("id","sortableListsPlaceholder").css(o.placeholderCss).addClass(o.placeholderClass),n=e("<li />").attr("id","sortableListsHint").css(o.hintCss).addClass(o.hintClass),a=e("<"+o.listSelector+" />").attr("id","sortableListsHintWrapper").addClass(o.listsClass+" "+o.hintWrapperClass).css(o.listsCss).css(o.hintWrapperCss),c=e("<span />").addClass("sortableListsOpener "+o.opener.openerClass).css(o.opener.openerCss).on("mousedown",function(s){var l=e(this).closest("li");return l.hasClass("sortableListsClosed")?C(l):y(l),!1});"class"==o.opener.as?c.addClass(o.opener.close):"html"==o.opener.as?c.html(o.opener.close):(c.css("background-image","url("+o.opener.close+")"),console.error("jQuerySortableLists opener as background image is deprecated. In version 2.0.0 it will be removed. Use html instead please."));var d={isDragged:!1,isRelEFP:null,oEl:null,rootEl:null,cEl:null,upScroll:!1,downScroll:!1,pX:0,pY:0,cX:0,cY:0,isAllowed:!0,e:{pageX:0,pageY:0,clientX:0,clientY:0},doc:e(document),win:e(window)};if(o.opener.active){if(!o.opener.open)throw"Opener.open value is not defined. It should be valid url, html or css class.";if(!o.opener.close)throw"Opener.close value is not defined. It should be valid url, html or css class.";e(this).find("li").each(function(){var s=e(this);s.children(o.listSelector).length&&(c.clone(!0).prependTo(s.children("div").first()),s.hasClass("sortableListsOpen")?C(s):y(s))})}return this.on("mousedown",function(s){var l=e(s.target);if(!(o.handle&&0===l.closest(o.handle).length||!1!==d.isDragged||o.ignoreClass&&l.hasClass(o.ignoreClass))){s.preventDefault();var t=l.closest("li"),a=e(this);t[0]&&(o.onDragStart(s,t),function(s,l,t){d.isDragged=!0;var a=parseInt(l.css("margin-top")),c=parseInt(l.css("margin-bottom")),h=parseInt(l.css("margin-left")),u=parseInt(l.css("margin-right")),g=l.offset(),v=l.innerHeight();d.rootEl={el:t,offset:t.offset(),rootElClass:t.attr("class")},d.cEl={el:l,mT:a,mL:h,mB:c,mR:u,offset:g},d.cEl.xyOffsetDiff={X:s.pageX-d.cEl.offset.left,Y:s.pageY-d.cEl.offset.top},d.cEl.el.addClass("sortableListsCurrent "+o.currElClass),l.before(i);var m=d.placeholderNode=e("#sortableListsPlaceholder");l.css({width:l.width(),position:"absolute",top:g.top-a,left:g.left-h}).prependTo(r),m.css({display:"block",height:v}),n.css("height",v),d.doc.on("mousemove",p).on("mouseup",f)}(s,t,a))}});function p(s){if(d.isDragged){var l=d.cEl,t=d.doc,r=d.win;s.pageX||function(e){e.pageY=d.pY,e.pageX=d.pX,e.clientY=d.cY,e.clientX=d.cX}(s),t.scrollTop()>d.rootEl.offset.top-10&&s.clientY<50?d.upScroll?(s.pageY=s.pageY-o.scroll,e("html, body").each(function(s){e(this).scrollTop(e(this).scrollTop()-o.scroll)}),h(s)):function(e){if(d.upScroll)return;d.upScroll=setInterval(function(){d.doc.trigger("mousemove")},50)}():t.scrollTop()+r.height()<d.rootEl.offset.top+d.rootEl.el.outerHeight(!1)+10&&r.height()-s.clientY<50?d.downScroll?(s.pageY=s.pageY+o.scroll,e("html, body").each(function(s){e(this).scrollTop(e(this).scrollTop()+o.scroll)}),h(s)):function(e){if(d.downScroll)return;d.downScroll=setInterval(function(){d.doc.trigger("mousemove")},50)}():u(d),d.oElOld=d.oEl,l.el[0].style.visibility="hidden",d.oEl=oEl=function(s,l){if(!document.elementFromPoint)return null;var t=d.isRelEFP;if(null===t){var o,r;(o=d.doc.scrollTop())>0&&(t=null==(r=document.elementFromPoint(0,o+e(window).height()-1))||"HTML"==r.tagName.toUpperCase()),(o=d.doc.scrollLeft())>0&&(t=null==(r=document.elementFromPoint(o+e(window).width()-1,0))||"HTML"==r.tagName.toUpperCase())}t&&(s-=d.doc.scrollLeft(),l-=d.doc.scrollTop());var i=e(document.elementFromPoint(s,l));if(!d.rootEl.el.find(i).length)return null;if(i.is("#sortableListsPlaceholder")||i.is("#sortableListsHint"))return null;if(!i.is("li"))return(i=i.closest("li"))[0]?i:null;if(i.is("li"))return i}(s.pageX,s.pageY),l.el[0].style.visibility="visible",function(e,s){var l=s.oEl;if(!l||!s.oElOld)return;var t=l.outerHeight(!1),r=e.pageY-l.offset().top;o.insertZonePlus?14>r?v(e,l,7>r):t-14<r&&b(e,l,t-7<r):5>r?g(e,l):t-5<r&&m(e,l)}(s,d),function(e,s){var l=s.cEl;l.el.css({top:e.pageY-l.xyOffsetDiff.Y-l.mT,left:e.pageX-l.xyOffsetDiff.X-l.mL})}(s,d)}}function f(s){var l=d.cEl,t=e("#sortableListsHint",d.rootEl.el),r=n[0].style,i=null,a=!1,h=e("#sortableListsHintWrapper");"block"==r.display&&t.length&&d.isAllowed?(i=t,a=!0):(i=d.placeholderNode,a=!1),offset=i.offset(),l.el.animate({left:offset.left-d.cEl.mL,top:offset.top-d.cEl.mT},250,function(){!function(e){var s=e.el[0].style;e.el.removeClass(o.currElClass+" sortableListsCurrent"),s.top="0",s.left="0",s.position="relative",s.width="auto"}(l),i.after(l.el[0]),i[0].style.display="none",r.display="none",t.remove(),h.removeAttr("id").removeClass(o.hintWrapperClass),h.length&&h.prev("div").append(c.clone(!0)),a?d.placeholderNode.slideUp(150,function(){d.placeholderNode.remove(),L(),o.onChange(l.el),o.complete(l.el),d.isDragged=!1}):(d.placeholderNode.remove(),L(),o.complete(l.el),d.isDragged=!1)}),u(d),d.doc.unbind("mousemove",p).unbind("mouseup",f)}function h(e){d.pY=e.pageY,d.pX=e.pageX,d.cY=e.clientY,d.cX=e.clientX}function u(e){clearInterval(e.upScroll),clearInterval(e.downScroll),e.upScroll=e.downScroll=!1}function g(s,l){if(e("#sortableListsHintWrapper",d.rootEl.el).length&&n.unwrap(),s.pageX-l.offset().left<o.insertZone){if(l.prev("#sortableListsPlaceholder").length)return void n.css("display","none");l.before(n)}else{var t=l.children(),r=l.children(o.listSelector).first();if(r.children().first().is("#sortableListsPlaceholder"))return void n.css("display","none");r.length?r.prepend(n):(t.first().after(n),n.wrap(a)),d.oEl&&C(l)}n.css("display","block"),d.isAllowed=o.isAllowed(d.cEl.el,n,n.parents("li").first())}function v(s,l,t){if(e("#sortableListsHintWrapper",d.rootEl.el).length&&n.unwrap(),!t&&s.pageX-l.offset().left>o.insertZone){var r=l.children(),i=l.children(o.listSelector).first();if(i.children().first().is("#sortableListsPlaceholder"))return void n.css("display","none");i.length?i.prepend(n):(r.first().after(n),n.wrap(a)),d.oEl&&C(l)}else{if(l.prev("#sortableListsPlaceholder").length)return void n.css("display","none");l.before(n)}n.css("display","block"),d.isAllowed=o.isAllowed(d.cEl.el,n,n.parents("li").first())}function m(s,l){if(e("#sortableListsHintWrapper",d.rootEl.el).length&&n.unwrap(),s.pageX-l.offset().left<o.insertZone){if(l.next("#sortableListsPlaceholder").length)return void n.css("display","none");l.after(n)}else{var t=l.children(),r=l.children(o.listSelector).last();if(r.children().last().is("#sortableListsPlaceholder"))return void n.css("display","none");r.length?t.last().append(n):(l.append(n),n.wrap(a)),d.oEl&&C(l)}n.css("display","block"),d.isAllowed=o.isAllowed(d.cEl.el,n,n.parents("li").first())}function b(s,l,t){if(e("#sortableListsHintWrapper",d.rootEl.el).length&&n.unwrap(),!t&&s.pageX-l.offset().left>o.insertZone){var r=l.children(),i=l.children(o.listSelector).last();if(i.children().last().is("#sortableListsPlaceholder"))return void n.css("display","none");i.length?r.last().append(n):(l.append(n),n.wrap(a)),d.oEl&&C(l)}else{if(l.next("#sortableListsPlaceholder").length)return void n.css("display","none");l.after(n)}n.css("display","block"),d.isAllowed=o.isAllowed(d.cEl.el,n,n.parents("li").first())}function C(e){e.removeClass("sortableListsClosed").addClass("sortableListsOpen"),e.children(o.listSelector).css("display","block");var s=e.children("div").children(".sortableListsOpener").first();"html"==o.opener.as?s.html(o.opener.close):"class"==o.opener.as?s.addClass(o.opener.close).removeClass(o.opener.open):s.css("background-image","url("+o.opener.close+")")}function y(e){e.removeClass("sortableListsOpen").addClass("sortableListsClosed"),e.children(o.listSelector).css("display","none");var s=e.children("div").children(".sortableListsOpener").first();"html"==o.opener.as?s.html(o.opener.open):"class"==o.opener.as?s.addClass(o.opener.open).removeClass(o.opener.close):s.css("background-image","url("+o.opener.open+")")}function L(){e(o.listSelector,d.rootEl.el).each(function(s){e(this).children().length||(e(this).prev("div").children(".sortableListsOpener").first().remove(),e(this).remove())})}},e.fn.sortableListsToArray=function(s,l){s=s||[];var t=0;return this.children("li").each(function(){var o=e(this),r={},i=o.attr("id");if(!i)throw console.log(o),"Previous item in console.log has no id. It is necessary to create the array.";r.id=i,r.parentId=l,r.value=o.data("value"),r.order=t,s.push(r),o.children("ul,ol").sortableListsToArray(s,i),t++}),s},e.fn.sortableListsToHierarchy=function(){var s=[],l=0;return e(this).children("li").each(function(){var t=e(this),o={},r=t.attr("id");if(!r)throw console.log(t),"Previous item in console.log has no id. It is necessary to create the array.";o.id=r,o.value=t.data("value"),o.order=l,s.push(o),o.children=t.children("ul,ol").sortableListsToHierarchy(),l++}),s},e.fn.sortableListsToString=function(s,l){return s=s||[],l=l||"no-parent",e(this).children("li").each(function(){var t=e(this),o=t.attr("id"),r=o?o.match(/(.+)[-=_](.+)/):null;if(!r)throw console.log(t),"Previous item in console.log has no id or id is not in required format xx_yy, xx-yy or xx=yy. It is necessary to create valid string.";s.push(r[1]+"["+r[2]+"]="+l),e(this).children("ul,ol").sortableListsToString(s,r[2])}),s.join("&")}}(jQuery);
